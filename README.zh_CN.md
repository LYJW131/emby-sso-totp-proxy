# Emby 统一认证代理

本项目是一个基于 **OpenResty (Nginx + Lua)** 和 **oauth2-proxy** 构建的 Emby 认证代理。它为 Emby 提供了一个统一的登录入口，支持 **OAuth2/OIDC (SSO)** 和 **TOTP (两步验证)** 两种登录方式，并能实现新用户自动注册。

## 项目架构

用户的所有请求首先会经过 OpenResty 代理：

- **Web 浏览器客户端**: 流量会被 `autologin.js` 脚本引导至 oauth2-proxy 进行 SSO 认证
- **其他客户端** (如 App): 流量会被引导至一个自定义登录页面 (`login.html`)，在此处使用 TOTP 验证码进行登录

                                +------------------+
                                |      用户        |
                                | (浏览器 / App)   |
                                +--------+---------+
                                         |
                                         v
+-------------------------------------------------------------------------+
|                                OpenResty (Nginx + Lua) 8096 端口         |
|                                                                         |
|  +--------------------------+         +-------------------------------+ |
|  |     Lua 认证处理         |         |      OAuth2/OIDC 流程         | |
|  | (TOTP 验证, 速率限制)  <----+------>| (autologin.js / oauth2-proxy) | |
|  +--------------------------+         +-------------------------------+ |
|                 |                                      |                |
|                 | (Web 客户端自动创建)                   | (TOTP 客户端)      |
|                 v                                      v                |
|  +-------------------------------------------------------------------+  |
|  |                      后端 Emby 服务器 (8096 端口)                    |  |
|  +-------------------------------------------------------------------+  |
|                                                                         |
+-------------------------------------------------------------------------+


## 主要功能

### 🔐 双重认证模式

- **OAuth2/OIDC**: 完美集成 oauth2-proxy，为 Web 客户端提供单点登录 (SSO) 支持  
  （例如使用 Synology SSO, Authelia, Keycloak 等）

- **TOTP**: 为不支持 SSO 的客户端（如 Emby 移动或电视 App）提供基于时间的一次性密码登录

### 👤 自动用户创建

通过 SSO 登录的新用户，如果 Emby 账户不存在，系统将使用 Emby API 自动为其创建账户

### 🎯 自动策略应用

新创建的 Emby 账户会自动应用一套预设的权限策略（默认为隐藏并不给予任何媒体库权限）

### 🎨 自定义登录页

为 TOTP 登录提供了一个独立的 `login.html` 页面

### 🔄 自动登录脚本

向 Emby Web UI 注入 `autologin.js`，实现 OAuth2 认证状态检查和自动登录重定向

### 🚪 登出劫持

劫持 Emby Web UI 的登出按钮，确保用户同时从 oauth2-proxy (SSO) 退出登录

### ⏱️ 速率限制

对认证接口 (`authenticatebyname`) 提供了基于 Lua 的速率限制，防止暴力破解

## 使用教程

### 1️⃣ 前提条件

- ✅ 一台已经安装好 **Docker** 和 **Docker Compose** 的服务器
- ✅ 一个正在运行的 **Emby 服务器**
- ✅ 一个可用的 **OAuth2/OIDC 提供商** (例如 Synology SSO, Authelia, Keycloak, Google 等)
- ✅ 准备好的 **SSL 证书**

### 2️⃣ Emby 后端配置

在启动代理之前，**必须先对 Emby 服务器进行必要的配置**：

1. **关闭 Emby 密码认证** ⚠️ **重要**
   - 禁用 Emby 内置的密码认证，改由本代理统一管理

2. **隐藏所有用户**（建议）
   - 进入 **管理** → **用户及权限**
   - 将除了管理员外的所有用户设置为 **不显示** 或 **隐藏**
   - 这可以防止在登录界面显示用户列表

3. **现有用户迁移至 SSO**
   - 如果你的 Emby 中已有用户想要接入 SSO，**必须确保**：
     - Emby 中的用户名 = SSO 提供商（如 Keycloak、Authelia）中的用户名 **完全一致**
     - 这样 SSO 登录时系统才能正确识别并登录现有用户

4. **新 SSO 用户的权限设置**
   - 新的 SSO 用户注册时，系统会自动以 **最低权限** 进行创建
   - 默认情况下，新用户 **不会获得任何媒体库访问权限**
   - 管理员可以手动调整权限，或修改代码中的默认策略以自动分配权限
   - 默认策略配置位置：`lua/set_policy.lua` 文件

#### 🔐 API 密钥设置

1. 进入 **管理** → **API 密钥** → **新增 API 密钥**
2. 为代理创建一个专用的 API 密钥
3. 将此密钥复制到 `.env` 文件的 `EMBY_API_KEY` 字段

### 3️⃣ 配置文件修改

完成 Emby 后端配置后，根据你的环境修改 `.env` 文件。这是所有服务的环境变量配置。

```env
# 【服务器域名】
# 必须配置！你的 Emby 服务器域名（用于 SSL 证书匹配）
# 如果未设置此环境变量，nginx 启动时会失败并报错
SERVER_NAME=emby.your-domain.com

# 【SSL 证书路径】
# 必须配置！主机上 SSL 证书文件的完整路径
# 如果未设置此环境变量，docker-compose 启动时会失败
SSL_CERT_PATH=/path/to/your/fullchain.pem
SSL_KEY_PATH=/path/to/your/privkey.pem

# 【Emby 后端服务器地址】
# 必须配置！后端 Emby 服务器的完整地址（包含协议和端口）
# 如果未设置此环境变量，nginx 启动时会失败并报错
EMBY_BACKEND=http://192.168.1.100:8096

# 【Emby API Key】
# 必须配置！用于自动创建用户和设置策略
# 前往管理员的 Emby 后台 -> API 密钥 -> 新增 API 密钥
EMBY_API_KEY=YOUR_EMBY_API_KEY_HERE

# 【TOTP 配置】
# 添加你的需要使用 TOTP 的用户和他们的 16 位 Base32 TOTP 密钥 (区分大小写)
# 格式: '{"用户名1":"密钥1", "用户名2":"密钥2"}'
USER_TOTP_SECRETS='{"admin":"JBSWY3DPEHPK3PXP"}'

# 【OAuth2-Proxy 基础配置】
# 具体请参考 OAuth2-Proxy 官方项目文档
```

### 4️⃣ 启动服务

完成所有配置修改后，在项目根目录运行：

```bash
docker-compose up -d
```

### 5️⃣ 登录流程

#### (1) 🌐 Web 浏览器 (SSO 登录)

1. 打开浏览器，访问 `https://emby.your-domain.com:8096`
2. 默认使用 SSO 登录，自动重定向到 IdP
3. `autologin.js` 脚本将自动为你登录 Emby
4. 如果 Emby 账户不存在：代理将使用你的 SSO 用户名自动创建 Emby 账户（应用默认策略），然后登录
5. 如果 Emby 账户已存在：你将直接登录

> 💡 **提示**: 如果需要使用 TOTP 登录 Web，需要手动访问 `https://emby.your-domain.com:8096/login.html`

#### (2) 📱 移动/电视 App (TOTP 登录)

1. 在你的身份验证器 App (如 Google Authenticator, Authy) 中，添加一个新条目，选择"手动输入"
2. 输入你在 `.env` 中为该用户配置的 **16 位 Base32 密钥**
3. 在 App 的登录页面，**服务器地址** 填写 `https://emby.your-domain.com:8096`
4. 在 **用户名** 字段，输入你在 `.env` 中配置的用户名
5. 在 **密码** 字段，输入你身份验证器 App 中显示的 **6 位 TOTP 验证码**
6. 点击登录

## ⚠️ 重要声明

### 代码来源

**本项目代码完全由生成式人工智能完成。** 虽然已经经过了初步的安全检验，但是**不保证绝对安全性**。

在生产环境中使用本项目之前，**强烈建议您自行进行完整的安全审查和测试**，包括但不限于：
- 代码安全审计
- 依赖项安全检查
- 网络安全测试
- 认证和授权流程验证

使用本项目产生的任何安全问题、数据泄露或其他损失，用户应自行承担责任。

## 🙏 致谢

本项目使用了 [oauth2-proxy](https://github.com/oauth2-proxy/oauth2-proxy) 项目来实现 OAuth2/OIDC 认证功能。详情请参考 [oauth2-proxy GitHub 仓库](https://github.com/oauth2-proxy/oauth2-proxy)。

## 📄 许可证

本项目采用 **MIT 许可证**。详见 [`LICENSE`](./LICENSE) 文件。

MIT 许可证允许您自由地使用、修改和分发本项目，包括用于商业用途，唯一的要求是在副本或衍生作品中保留原始许可证和版权声明。