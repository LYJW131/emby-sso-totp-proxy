worker_processes 1;

events {
    worker_connections 1024;
}

http {
    lua_need_request_body on;
    client_max_body_size 0;
    sendfile off;
    default_type text/html;

    types {
        text/html html htm;
    }

    lua_shared_dict injected_script 1m;
    lua_shared_dict rate_limit 10m;
    lua_shared_dict used_totp 10m;
    init_by_lua_file /usr/local/openresty/nginx/lua/init.lua;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    server {
        listen 8096 ssl;
        set_by_lua_block $server_name_var {
            return _G.server_name
        }
        server_name $server_name_var;
        ssl_certificate /etc/nginx/ssl/certificate.crt;
        ssl_certificate_key /etc/nginx/ssl/private.key;

        set_by_lua_block $emby_backend {
            return _G.emby_backend
        }

        location /oauth2/ {
            proxy_pass       http://oauth2-proxy:4180;
            proxy_set_header Host                    $host;
            proxy_set_header X-Real-IP               $remote_addr;
            proxy_set_header X-Auth-Request-Redirect $request_uri;
        }
        location = /oauth2/auth {
            proxy_pass       http://oauth2-proxy:4180;
            proxy_set_header Host             $host;
            proxy_set_header X-Real-IP        $remote_addr;
            proxy_set_header X-Forwarded-Uri  $request_uri;
            proxy_set_header Content-Length   "";
            proxy_pass_request_body           off;
        }

        location = /emby/Users/authenticatebyname {
            access_by_lua_file /usr/local/openresty/nginx/lua/access.lua;
            content_by_lua_file /usr/local/openresty/nginx/lua/content.lua;
        }

        location = /Users/AuthenticateByName {
            access_by_lua_file /usr/local/openresty/nginx/lua/access_json.lua;
            content_by_lua_file /usr/local/openresty/nginx/lua/content_json.lua;
        }

        location /emby_proxy_auth {
            internal;

            proxy_pass $emby_backend$request_uri;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept $http_accept;
            proxy_set_header Accept-Language $http_accept_language;
            proxy_set_header Accept-Encoding $http_accept_encoding;
            proxy_set_header User-Agent $http_user_agent;
            proxy_set_header Origin $http_origin;
            proxy_set_header Referer $http_referer;

            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_buffering off;
        }

        location /emby_create_user {
            internal;
            
            access_by_lua_file /usr/local/openresty/nginx/lua/create_user.lua;
            
            proxy_pass $emby_backend/emby/Users/New;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Content-Type "application/x-www-form-urlencoded";
            proxy_set_header Accept-Encoding "";

            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_buffering off;
        }

        location /emby_set_user_policy {
            internal;
            
            rewrite_by_lua_file /usr/local/openresty/nginx/lua/set_policy.lua;
            
            proxy_pass $emby_backend;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Content-Type "application/json";
            proxy_set_header Accept-Encoding "";

            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_buffering off;
        }

        location /autologin.js {
            alias /usr/local/openresty/nginx/html/autologin.js;
            default_type "application/javascript; charset=UTF-8";
            expires 1d;
            add_header Cache-Control "public, max-age=2592000, immutable";
            add_header Pragma "public";
            etag on;
        }

        location /logout-hijack.js {
            alias /usr/local/openresty/nginx/html/logout-hijack.js;
            default_type "application/javascript; charset=UTF-8";
            expires 1d;
            add_header Cache-Control "public, max-age=2592000, immutable";
            add_header Pragma "public";
            etag on;
        }

        location = /login.html {
            alias /usr/local/openresty/nginx/html/login.html;
            default_type "text/html; charset=UTF-8";
            expires 1d;
            add_header Cache-Control "public, max-age=2592000, immutable";
            add_header Pragma "public";
            etag on;
        }

        location = /web/index.html {
            access_by_lua_block {
                ngx.log(ngx.INFO, "Proxying request to Emby: " .. ngx.var.request_uri)
                ngx.var.injected_script = ngx.shared.injected_script:get("auto_login") or ""
            }
            set $injected_script '';
            proxy_pass $emby_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_max_temp_file_size 512m;
            proxy_temp_file_write_size 256k;
            proxy_request_buffering off;
            sub_filter '</head>' '${injected_script}</head>';
            sub_filter_once on;
        }

        location / {
            proxy_pass $emby_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

